<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tr√≤ Ch∆°i C√¢u C√° - H√¨nh H·ªçc</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            --font-head: 'Fredoka One', cursive;
            --font-body: 'Nunito', sans-serif;
            --primary-orange: #f57c00;
        }

        body {
            margin: 0; padding: 0; overflow: hidden; font-family: var(--font-body);
            background-color: #222; display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw; user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }

        #game-stage {
            position: relative; width: 100%; height: 100vh;
            background: #000; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- 1. H√åNH N·ªÄN & √ÅNH N·∫ÆNG --- */
        #bg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #bg-img { width: 100%; height: 100%; object-fit: cover; }

        .sun-rays {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
            z-index: 2; pointer-events: none;
        }
        .sun-rays::after {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: repeating-conic-gradient(from 0deg, transparent 0deg 15deg, rgba(255,255,224,0.08) 15deg 30deg);
            animation: raysRotate 80s linear infinite;
        }
        @keyframes raysRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- 2. M·∫∂T N∆Ø·ªöC & C√Å --- */
        #water-container {
            position: absolute; bottom: 0; width: 100%; height: 40%; z-index: 5;
            background: linear-gradient(to bottom, rgba(41, 182, 246, 0.5) 0%, rgba(2, 136, 209, 0.9) 100%); 
        }
        .wave { position: absolute; bottom: 100%; width: 200%; height: 40px; background-repeat: repeat-x; background-size: 50% 100%; }
        .wave1 { bottom: 95%; left: 0; opacity: 0.6; z-index: 1; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1000 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,50 Q250,0 500,50 T1000,50 L1000,100 L0,100 Z" fill="%234fc3f7"/></svg>'); animation: waveMove 15s linear infinite; }
        .wave2 { bottom: 90%; left: -50px; opacity: 0.8; z-index: 2; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1000 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,50 Q250,80 500,50 T1000,50 L1000,100 L0,100 Z" fill="%2329b6f6"/></svg>'); animation: waveMove 10s linear infinite reverse; }
        .wave3 { bottom: 0; top: -15px; width: 200%; height: 40px; z-index: 15; background-image: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1000 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,30 Q250,0 500,30 T1000,30 L1000,100 L0,100 Z" fill="%230288d1"/></svg>'); opacity: 0.4; animation: waveMove 8s linear infinite; }
        @keyframes waveMove { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .fish-shadow { position: absolute; font-size: 28px; opacity: 0.4; z-index: 6; pointer-events: none; }

        /* --- 3. THUY·ªÄN & NH√ÇN V·∫¨T --- */
        #boat-group {
            position: absolute; bottom: 30%; left: 50%; width: 400px; height: 300px; 
            z-index: 10; transform: translateX(-50%); pointer-events: none;
        }
        .floating { animation: floatBoat 3s ease-in-out infinite; }
        @keyframes floatBoat { 0%, 100% { transform: translateX(-50%) translateY(0) rotate(-1deg); } 50% { transform: translateX(-50%) translateY(5px) rotate(1deg); } }

        .vibrating { animation: vibrate 0.3s linear; }
        @keyframes vibrate {
            0% { transform: translateX(-50.5%) translateY(2px); }
            20% { transform: translateX(-49.5%) translateY(-2px); }
            40% { transform: translateX(-50.5%) translateY(2px); }
            60% { transform: translateX(-49.5%) translateY(-2px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        #boat-svg { position: absolute; bottom: 0; left: 0; width: 100%; height: auto; z-index: 1; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.3)); }
        #char-img-el { position: absolute; bottom: 65px; left: 50%; transform: translateX(-50%); width: 240px; height: auto; z-index: 2; }

        /* --- 4. GIAO DI·ªÜN C√ÇU H·ªéI (D·ªåC) --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
        }
        .screen.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .quiz-modal { 
            background: #fff; padding: clamp(15px, 3vh, 30px); border-radius: 35px; 
            width: 900px; max-width: 94%; max-height: 94vh;
            display: flex; gap: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); border: 8px solid #e1f5fe;
            box-sizing: border-box; transition: all 0.3s ease; overflow-y: auto;
        }

        .quiz-left { flex: 1; text-align: left; display: flex; flex-direction: column; justify-content: center; }
        
        .no-image .quiz-modal { width: 700px; height: auto; flex-direction: column; align-items: center; }
        .no-image .quiz-left { text-align: center; width: 100%; }
        .no-image #q-content { text-align: center; border-left: none; padding-left: 0; font-size: 1.8rem; margin: 20px 0; }

        .has-image .quiz-modal { flex-direction: row; }
        .has-image .quiz-right { 
            flex: 1.2; display: flex; align-items: center; justify-content: center; 
            background: #f1f8e9; border-radius: 20px; border: 3px solid #eee; overflow: hidden;
        }
        .has-image .quiz-right img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .quiz-title-box { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .quiz-title { color: var(--primary-orange); font-family: var(--font-head); font-size: 2.2rem; margin: 0; }
        
        .timer-container { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
        .timer-svg { transform: rotate(-90deg); width: 80px; height: 80px; }
        .timer-bg { fill: none; stroke: #f5f5f5; stroke-width: 8; }
        .timer-progress { fill: none; stroke: var(--primary-orange); stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s linear; }
        .timer-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: var(--font-head); font-size: 1.8rem; color: var(--primary-orange); }

        #q-content { font-size: 1.4rem; font-weight: bold; color: #333; margin-bottom: 15px; line-height: 1.4; border-left: 8px solid #4facfe; padding-left: 20px; }
        .grid-opts { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .btn-opt { background: #fff; border: 2px solid #cfd8dc; padding: 15px 25px; border-radius: 18px; font-size: 1.2rem; cursor: pointer; font-weight: bold; color: #455a64; text-align: left; transition: 0.2s; box-shadow: 0 4px 0 #eceff1; }
        .btn-opt:hover { background: #e0f7fa; border-color: #0288d1; color: #01579b; transform: translateY(-2px); }

        /* --- REEL SCREEN --- */
        .reel-modal { background: rgba(255,255,255,0.98); padding: 30px; border-radius: 40px; text-align: center; width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); pointer-events: none; }
        .energy-circle-container { position: relative; width: 220px; height: 220px; margin: 20px auto; }
        .energy-svg { transform: rotate(-90deg); width: 220px; height: 220px; }
        .energy-bg { fill: none; stroke: #eee; stroke-width: 15; }
        .energy-progress { fill: none; stroke: #4caf50; stroke-width: 15; stroke-linecap: round; transition: stroke-dashoffset 0.1s; }
        .energy-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: var(--font-head); font-size: 3rem; color: #2e7d32; }

        /* --- TH√îNG B√ÅO TH·∫§T B·∫†I --- */
        .fail-card { background: #fff; padding: 30px; border-radius: 35px; width: 450px; text-align: center; border: 6px solid #b0bec5; box-shadow: 0 20px 50px rgba(0,0,0,0.4); }

        /* --- CHI·∫æN L·ª¢I PH·∫®M (THU NH·ªé ƒê·ªÇ KH√îNG B·ªä CHE) --- */
        .fish-card {
            background: #fff; padding: 0; border-radius: 35px; width: 480px; max-width: 90%; text-align: center;
            border: 6px solid #ffd700; box-shadow: 0 20px 50px rgba(0,0,0,0.5); overflow: hidden;
        }
        .fish-card-header { background: linear-gradient(90deg, #ff6f00 0%, #ff8f00 100%); padding: 15px; color: white; font-family: var(--font-head); font-size: 1.8rem; }
        .fish-avatar { font-size: 90px; margin: 5px 0; animation: bounce 1s infinite; }
        .fish-stats { display: flex; flex-direction: column; gap: 10px; background: #f1f8e9; padding: 15px; border-radius: 20px; margin: 10px 40px; border: 2px solid #c5e1a5; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #0277bd; font-family: var(--font-head); }

        /* B·∫¢NG T·ªîNG K·∫æT CU·ªêI */
        #final-fish-list { text-align: left; background: #f8f9fa; padding: 15px; border-radius: 20px; margin: 15px 30px; border: 2px dashed #ddd; max-height: 180px; overflow-y: auto; }
        .final-fish-item { font-size: 1.1rem; color: #333; font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 3px; display: flex; justify-content: space-between; }
        .final-fish-item span { color: #0288d1; }

        .game-title-3d { font-family: var(--font-head); font-size: clamp(3rem, 10vw, 6rem); color: #fff; text-align: center; margin-bottom: 20px; text-shadow: 5px 5px 0px #2979ff, 10px 10px 20px rgba(0,0,0,0.4); animation: titleBounce 2s infinite; }
        @keyframes titleBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        #hud-count { position: absolute; top: 20px; right: 20px; background: white; padding: 10px 25px; border-radius: 40px; font-family: var(--font-head); font-size: 1.2rem; box-shadow: 0 8px 20px rgba(0,0,0,0.2); z-index: 50; color: #0277bd; border: 3px solid #e1f5fe; }
        .btn-game { font-family: var(--font-head); padding: 15px 50px; font-size: 1.8rem; background: linear-gradient(to bottom, #ff9800, #f57c00); color: white; border: 4px solid #fff; border-radius: 70px; cursor: pointer; box-shadow: 0 8px 0 #e65100; margin-top: 10px; transition: 0.1s; }
        .btn-game:active { transform: translateY(6px); box-shadow: 0 2px #e65100; }
        #interaction-layer { position: absolute; width: 100%; height: 100%; z-index: 20; cursor: pointer; display: none; }
        
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body onmousedown="Game.handleGlobalClick(event)">

<div id="game-stage">
    
    <div id="bg-container">
        <img id="bg-img" src="./images/nen_bien.jpg" onerror="this.src='https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1000&auto=format&fit=crop'">
        <div class="sun-rays"></div>
    </div>

    <div id="water-container">
        <div id="fish-layer" style="position: absolute; width: 100%; height: 100%; z-index: 5;"></div>
        <div class="wave wave1"></div>
        <div class="wave wave2"></div>
        <div class="wave wave3"></div>
    </div>

    <div id="boat-group">
        <svg id="boat-svg" viewBox="0 0 400 200">
            <path d="M20,80 Q200,160 380,80 L360,50 L40,50 Z" fill="#8D6E63" stroke="#5D4037" stroke-width="4"/>
            <path d="M40,50 L360,50" stroke="#fff" stroke-width="4" opacity="0.3"/>
            <rect x="120" y="50" width="160" height="12" fill="#5D4037" rx="3"/>
            <path d="M60,75 L340,75" stroke="#6D4C41" stroke-width="2" opacity="0.5"/>
        </svg>
        <!-- Nh√¢n v·∫≠t c·ªßa b·∫°n -->
        <img id="char-img-el" src="./images/nhan_vat_moi.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4860/4860847.png'">
    </div>

    <div id="hud-count">C√¢u: <span id="q-current">1</span>/6</div>
    <div id="interaction-layer" onclick="Game.castLine()"></div>

    <!-- M√ÄN H√åNH B·∫ÆT ƒê·∫¶U -->
    <div id="screen-start" class="screen active" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h1 class="game-title-3d">TR√í CH∆†I<br>C√ÇU C√Å</h1>
        <button class="btn-game" onclick="Game.start()">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <!-- M√ÄN H√åNH C√ÇU H·ªéI -->
    <div id="screen-quiz" class="screen">
        <div class="quiz-modal" id="quiz-modal">
            <div class="quiz-left">
                <div class="quiz-title-box">
                    <h2 class="quiz-title">‚ö†Ô∏è C√Å C·∫ÆN C√ÇU!</h2>
                    <div class="timer-container">
                        <svg class="timer-svg">
                            <circle class="timer-bg" cx="40" cy="40" r="35"></circle>
                            <circle id="timer-progress" class="timer-progress" cx="40" cy="40" r="35" stroke-dasharray="219.9" stroke-dashoffset="0"></circle>
                        </svg>
                        <div id="timer-text" class="timer-text">20</div>
                    </div>
                </div>
                <div id="q-content">...</div>
                <div id="q-options" class="grid-opts"></div>
            </div>
            <div class="quiz-right" id="quiz-right" style="display:none;">
                <img id="q-img" src="" alt="Minh h·ªça">
            </div>
        </div>
    </div>

    <!-- M√ÄN H√åNH K√âO C√Å -->
    <div id="screen-reel" class="screen">
        <div class="reel-modal">
            <h2 style="color:#d32f2f; font-size:2.2rem; font-family:var(--font-head); margin-bottom: 5px;">üî• K√âO NGAY! üî•</h2>
            <p style="color:#666; font-weight: bold; margin: 0;">B·∫•m li√™n t·ª•c v√†o m√†n h√¨nh!</p>
            <div class="energy-circle-container">
                <svg class="energy-svg">
                    <circle class="energy-bg" cx="110" cy="110" r="100"></circle>
                    <circle id="energy-progress" class="energy-progress" cx="110" cy="110" r="100" stroke-dasharray="628" stroke-dashoffset="314"></circle>
                </svg>
                <div id="energy-text" class="energy-text">50%</div>
            </div>
        </div>
    </div>

    <!-- M√ÄN H√åNH K·∫æT QU·∫¢ C√ÇU ƒê∆Ø·ª¢C -->
    <div id="screen-result" class="screen">
        <div class="fish-card">
            <div class="fish-card-header">üéâ CHI·∫æN L·ª¢I PH·∫®M!</div>
            <div class="fish-card-body">
                <div id="res-img" class="fish-avatar">üêü</div>
                <h3 id="res-name" style="font-family:var(--font-head); font-size:1.8rem; color:#0277bd; margin:5px 0;">...</h3>
                <div class="fish-stats">
                    <div class="stat-item"><span style="color:#558b2f; font-weight:bold;">Kh·ªëi l∆∞·ª£ng</span> <span class="stat-value"><span id="res-weight">0</span> kg</span></div>
                    <div class="stat-item"><span style="color:#2e7d32; font-weight:bold;">ƒêi·ªÉm s·ªë</span> <span class="stat-value" style="color:#4caf50;">+<span id="res-score">0</span> ‚≠ê</span></div>
                </div>
                <button class="btn-game" onclick="Game.resetToLake()">TI·∫æP T·ª§C</button>
            </div>
        </div>
    </div>

    <!-- M√ÄN H√åNH C√Å CH·∫†Y -->
    <div id="screen-fail" class="screen">
        <div class="fail-card">
            <h2 style="color:#78909c; font-family:var(--font-head); font-size:2.5rem; margin:0;">üí¶ C√Å CH·∫†Y M·∫§T!</h2>
            <div style="font-size: 70px; margin: 10px 0;">üåä</div>
            <p id="fail-msg" style="font-size: 1.4rem; font-weight: bold; color: #546e7a;">...</p>
            <button class="btn-game" style="background:#b0bec5; border-color:#eee; box-shadow:0 6px #78909c;" onclick="Game.resetToLake()">TI·∫æP T·ª§C</button>
        </div>
    </div>
    
    <!-- M√ÄN H√åNH CH√öC M·ª™NG CU·ªêI C√ôNG -->
    <div id="screen-end" class="screen">
        <div class="fish-card" style="border-color: #4caf50; width: 550px;">
            <div class="fish-card-header" style="background: linear-gradient(90deg, #4caf50 0%, #81c784 100%);">üèÜ CH√öC M·ª™NG! üèÜ</div>
            <div class="fish-card-body">
                <div style="font-size: 80px; margin-bottom: 5px;">üéä</div>
                <h2 style="font-family:var(--font-head); color:#0277bd; margin: 0;">B·∫†N ƒê√É HO√ÄN TH√ÄNH!</h2>
                <p style="font-weight: bold; color: #555; font-size: 1.1rem; margin-top: 15px;">Danh s√°ch c√° ƒë√£ c√¢u ƒë∆∞·ª£c:</p>
                <div id="final-fish-list"></div>
                <button class="btn-game" onclick="location.reload()">CH∆†I L·∫†I</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* --- H·ªÜ TH·ªêNG √ÇM THANH --- */
    const AudioSys = {
        ctx: null,
        init() { try { const AC = window.AudioContext || window.webkitAudioContext; if(AC) this.ctx = new AC(); } catch(e){} },
        playTone(freq, type, duration, vol=0.1) {
            if(!this.ctx) this.init(); if(!this.ctx) return;
            if(this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
            osc.connect(gain); gain.connect(this.ctx.destination); osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        sfxBite() { this.playTone(800, 'square', 0.1, 0.1); },
        sfxWin() { [523, 659, 784, 1046].forEach((f, i) => setTimeout(() => this.playTone(f, 'triangle', 0.3, 0.2), i*150)); },
        sfxFail() { [400, 300, 200].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.4, 0.1), i*200)); },
        sfxPull() { this.playTone(450 + Math.random()*100, 'sine', 0.05, 0.05); }
    };

    /* --- DATA C√ÇU H·ªéI --- */
    const DB_QUESTIONS = [
        { id: 1, q: "ƒêi·ªÅn v√†o ch·ªó tr·ªëng ƒë·ªÉ ho√†n th√†nh ƒê·ªãnh l√≠ Thales: \"N·∫øu m·ªôt ƒë∆∞·ªùng th·∫≥ng song song v·ªõi m·ªôt c·∫°nh c·ªßa tam gi√°c v√† c·∫Øt hai c·∫°nh c√≤n l·∫°i th√¨ n√≥ ƒë·ªãnh ra tr√™n hai c·∫°nh ƒë√≥ nh·ªØng ƒëo·∫°n th·∫≥ng _______.\"", a: ["A. b·∫±ng nhau", "B. song song", "C. t∆∞∆°ng ·ª©ng t·ªâ l·ªá", "D. vu√¥ng g√≥c"], c: 2, img: "", diff: 0.2 },
        { id: 2, q: "D·ª±a v√†o h√¨nh v·∫Ω b√™n, h√£y t√≠nh ƒë·ªô d√†i c·∫°nh NL.", a: ["A. NL = 1.8", "B. NL = 2.4", "C. NL = 2.8", "D. NL = 3.2"], c: 2, img: "./images/q2.png", diff: 0.32 },
        { id: 3, q: "ƒêi·ªÅn v√†o ch·ªó tr·ªëng ƒë·ªÉ ho√†n th√†nh ƒê·ªãnh l√≠ Thales ƒë·∫£o: \"N·∫øu m·ªôt ƒë∆∞·ªùng th·∫≥ng c·∫Øt hai c·∫°nh c·ªßa m·ªôt tam gi√°c v√† ƒë·ªãnh ra tr√™n hai c·∫°nh n√†y nh·ªØng ƒëo·∫°n th·∫≥ng t∆∞∆°ng ·ª©ng t·ªâ l·ªá th√¨ ƒë∆∞·ªùng th·∫≥ng ƒë√≥ _______ v·ªõi c·∫°nh c√≤n l·∫°i c·ªßa tam gi√°c.\"", a: ["A. tr√πng", "B. c·∫Øt", "C. vu√¥ng g√≥c", "D. song song"], c: 3, img: "", diff: 0.22 },
        { id: 4, q: "T√¨m x v√† y trong h√¨nh v·∫Ω b√™n.", a: ["A. x=5, y=25", "B. x=6, y=30", "C. x=7, y=35", "D. x=4, y=20"], c: 1, img: "./images/q4.png", diff: 0.35 },
        { id: 5, q: "ƒêi·ªÅn v√†o ch·ªó tr·ªëng ƒë·ªÉ ho√†n th√†nh H·ªá qu·∫£ ƒë·ªãnh l√≠ Thales: \"N·∫øu m·ªôt ƒë∆∞·ªùng th·∫≥ng c·∫Øt hai c·∫°nh c·ªßa m·ªôt tam gi√°c v√† song song v·ªõi c·∫°nh c√≤n l·∫°i th√¨ n√≥ t·∫°o th√†nh m·ªôt tam gi√°c m·ªõi c√≥ ba c·∫°nh _______ v·ªõi ba c·∫°nh c·ªßa tam gi√°c ƒë√£ cho.\"", a: ["A. b·∫±ng nhau", "B. song song", "C. t∆∞∆°ng ·ª©ng t·ªâ l·ªá", "D. ƒë·ªëi x·ª©ng"], c: 2, img: "", diff: 0.24 },
        { id: 6, q: "D·ª±a v√†o h√¨nh v·∫Ω b√™n, gi√° tr·ªã ƒë·ªô d√†i c·∫°nh x l√† bao nhi√™u?", a: ["A. x = 6.8", "B. x = 7.4", "C. x = 8.4", "D. x = 9.2"], c: 2, img: "./images/q6.png", diff: 0.4 }
    ];

    /* --- DATA C√Å --- */
    const FISH_SPECIES = [
        { name: "C√° Ch√©p Th·∫ßn K·ª≥", img: "üêü", minKg: 10, maxKg: 20, decay: 0.4, fishCoeff: 0.1 },
        { name: "C√° R·ªìng B·∫°ch Kim", img: "üêâ", minKg: 50, maxKg: 80, decay: 0.5, fishCoeff: 0.12 },
        { name: "C√° Ng·ª´ Kh·ªïng L·ªì", img: "üê°", minKg: 150, maxKg: 250, decay: 0.6, fishCoeff: 0.14 },
        { name: "C√° Ki·∫øm ƒê·∫°i D∆∞∆°ng", img: "ü¶à", minKg: 350, maxKg: 550, decay: 0.7, fishCoeff: 0.16 },
        { name: "C√° M·∫≠p Megalodon", img: "ü¶ñ", minKg: 2000, maxKg: 5000, decay: 0.8, fishCoeff: 0.18 },
        { name: "Th·ªßy Qu√°i Kraken", img: "üêô", minKg: 12000, maxKg: 25000, decay: 1.0, fishCoeff: 0.2 }
    ];

    const Game = {
        state: 'START', currentStep: 0, currentQ: null, currentFish: null,
        energy: 50, reelInterval: null, timeLeft: 20, timerInterval: null,
        timerCircleRadius: 35, energyCircleRadius: 100, fishPool: [], caughtFishList: [], timeAtAnswer: 0,

        init() {
            this.currentStep = 0; this.caughtFishList = [];
            this.updateCountUI(); this.spawnDecorFish(); AudioSys.init();
            this.fishPool = [...FISH_SPECIES].sort(() => Math.random() - 0.5);
            document.getElementById('bg-img').src = "./images/nen_bien.jpg";
        },

        handleGlobalClick(e) { if(this.state === 'REELING') this.reelPull(e); },

        start() { this.init(); document.getElementById('screen-start').classList.remove('active'); document.getElementById('boat-group').classList.add('floating'); document.getElementById('interaction-layer').style.display = 'block'; this.state = 'IDLE'; },

        spawnDecorFish() {
            const container = document.getElementById('fish-layer'); container.innerHTML = '';
            for(let i=0; i<8; i++){
                let f = document.createElement('div'); f.className = 'fish-shadow'; f.innerText = 'üêü';
                f.style.top = (30 + Math.random()*60) + '%'; f.style.left = '-10%';
                f.style.animation = `swimFish ${15 + Math.random()*20}s linear ${Math.random()*10}s infinite`;
                if(Math.random() > 0.5) f.style.transform = 'scaleX(-1)'; container.appendChild(f);
            }
            if(!document.getElementById('fish-anim-style')) {
                const s = document.createElement('style'); s.id = 'fish-anim-style';
                s.innerHTML = `@keyframes swimFish { 0% { left: -10%; } 100% { left: 110%; } }`;
                document.head.appendChild(s);
            }
        },

        castLine() {
            if (this.state !== 'IDLE' || this.currentStep >= DB_QUESTIONS.length) return;
            this.state = 'CASTING'; const boat = document.getElementById('boat-group'); boat.classList.add('vibrating');
            setTimeout(() => { boat.classList.remove('vibrating'); this.triggerBite(); }, 300);
        },

        triggerBite() { AudioSys.sfxBite(); this.currentQ = DB_QUESTIONS[this.currentStep]; this.calcFishData(); this.state = 'QUIZ'; this.renderQuiz(); },

        calcFishData() {
            const cfg = this.fishPool[this.currentStep % this.fishPool.length];
            const z = Math.floor(Math.random()*(cfg.maxKg - cfg.minKg) + cfg.minKg);
            this.currentFish = { ...cfg, w: z };
        },

        renderQuiz() {
            const screenQuiz = document.getElementById('screen-quiz');
            document.getElementById('screen-quiz').classList.add('active');
            document.getElementById('q-content').innerText = this.currentQ.q;
            const qRight = document.getElementById('quiz-right'); const qImg = document.getElementById('q-img');

            if(this.currentQ.img && this.currentQ.img !== "") {
                screenQuiz.classList.add('has-image'); screenQuiz.classList.remove('no-image');
                qRight.style.display = 'flex'; qImg.src = this.currentQ.img;
            } else {
                screenQuiz.classList.add('no-image'); screenQuiz.classList.remove('has-image');
                qRight.style.display = 'none';
            }

            const div = document.getElementById('q-options'); div.innerHTML = '';
            this.currentQ.a.forEach((opt, i) => {
                let btn = document.createElement('button'); btn.className = 'btn-opt';
                btn.innerText = opt; btn.onclick = (e) => { e.stopPropagation(); this.answer(i); }; div.appendChild(btn);
            });
            this.startTimer();
        },

        startTimer() {
            this.timeLeft = 20; this.updateTimerUI();
            if (this.timerInterval) clearInterval(this.timerInterval);
            this.timerInterval = setInterval(() => {
                this.timeLeft--; this.updateTimerUI();
                if (this.timeLeft <= 0) { clearInterval(this.timerInterval); this.failByTimeout(); }
            }, 1000);
        },

        updateTimerUI() {
            const circle = document.getElementById('timer-progress'); const text = document.getElementById('timer-text');
            const circumference = 2 * Math.PI * this.timerCircleRadius;
            const offset = circumference - (this.timeLeft / 20) * circumference;
            circle.style.strokeDasharray = circumference; circle.style.strokeDashoffset = offset;
            text.innerText = this.timeLeft;
        },

        failByTimeout() { AudioSys.sfxFail(); document.getElementById('screen-quiz').classList.remove('active'); this.showFail("H·∫øt th·ªùi gian r·ªìi!"); },

        answer(idx) {
            this.timeAtAnswer = 20 - this.timeLeft;
            clearInterval(this.timerInterval); document.getElementById('screen-quiz').classList.remove('active');
            if(idx === this.currentQ.c) this.startReeling(); else { AudioSys.sfxFail(); this.showFail("C√¢u tr·∫£ l·ªùi ch∆∞a ƒë√∫ng!"); }
        },

        startReeling() {
            this.state = 'REELING'; document.getElementById('screen-reel').classList.add('active');
            this.energy = 50; this.updateReelUI();
            if (this.reelInterval) clearInterval(this.reelInterval);
            this.reelInterval = setInterval(() => {
                this.energy -= this.currentFish.decay; if (this.energy <= 0) this.endReeling(false);
                this.updateReelUI();
            }, 50);
        },

        reelPull(e) {
            if(this.state !== 'REELING') return; if(e) e.preventDefault();
            this.energy += 12; AudioSys.sfxPull();
            if (this.energy >= 100) { this.energy = 100; this.updateReelUI(); this.endReeling(true); }
        },

        updateReelUI() {
            const circle = document.getElementById('energy-progress'); const text = document.getElementById('energy-text');
            const circumference = 2 * Math.PI * this.energyCircleRadius;
            const displayEnergy = Math.max(0, Math.min(100, this.energy));
            const offset = circumference - (displayEnergy / 100) * circumference;
            circle.style.strokeDasharray = circumference; circle.style.strokeDashoffset = offset;
            text.innerText = Math.floor(displayEnergy) + "%";
        },

        endReeling(win) {
            clearInterval(this.reelInterval); this.reelInterval = null;
            document.getElementById('screen-reel').classList.remove('active');
            if (win) { AudioSys.sfxWin(); this.showSuccess(); } 
            else { AudioSys.sfxFail(); this.showFail("C√° kh·ªèe qu√°!"); }
        },

        calculateScore() {
            const S = this.currentFish.fishCoeff;
            const D = this.currentQ.diff;
            let T = 0.3; if (this.timeAtAnswer > 5) T = 0.30 - 0.02 * (this.timeAtAnswer - 5); if (T < 0) T = 0;
            const z = this.currentFish.w, x = this.currentFish.minKg, y = this.currentFish.maxKg;
            const W = 0.1 * (z - x) / (y - x);
            return Math.floor(100 * (S + D + T + W)); 
        },

        showSuccess() {
            this.state = 'SUCCESS'; const score = this.calculateScore();
            this.caughtFishList.push({ name: this.currentFish.name, weight: this.currentFish.w });
            const modal = document.getElementById('screen-result'); modal.classList.add('active');
            document.getElementById('res-img').innerText = this.currentFish.img;
            document.getElementById('res-name').innerText = this.currentFish.name;
            document.getElementById('res-weight').innerText = this.currentFish.w;
            document.getElementById('res-score').innerText = score;
        },

        showFail(msg) { this.state = 'FAIL'; document.getElementById('screen-fail').classList.add('active'); document.getElementById('fail-msg').innerText = msg; },

        resetToLake() {
            document.querySelectorAll('.screen').forEach(s => { if(s.id !== 'game-stage') s.classList.remove('active'); });
            this.currentStep++; this.updateCountUI();
            if (this.currentStep === 2) document.getElementById('bg-img').src = "./images/nen_ho.jpg";
            if(this.currentStep >= DB_QUESTIONS.length) this.finishGame(); else this.state = 'IDLE';
        },

        updateCountUI() { document.getElementById('q-current').innerText = (this.currentStep + 1); },

        finishGame() {
            this.state = 'END'; const endScreen = document.getElementById('screen-end');
            const listDiv = document.getElementById('final-fish-list');
            if (this.caughtFishList.length > 0) {
                listDiv.innerHTML = this.caughtFishList.map((fish, index) => 
                    `<div class="final-fish-item">${index + 1}. ${fish.name} <span>${fish.weight}kg</span></div>`
                ).join('');
            } else { listDiv.innerHTML = '<p style="text-align:center; color:#888;">Ch∆∞a c√¢u ƒë∆∞·ª£c c√°.</p>'; }
            endScreen.classList.add('active');
        }
    };
</script>
</body>
</html>